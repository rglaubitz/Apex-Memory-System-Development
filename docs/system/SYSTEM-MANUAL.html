<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Apex Memory System - Technical Manual & Architecture</title>
    <style>
        /* ===========================
           GLOBAL STYLES
           =========================== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            line-height: 1.6;
            color: #333;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            overflow: hidden;
        }

        /* ===========================
           HEADER
           =========================== */
        header {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            padding: 40px;
            text-align: center;
        }

        header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 700;
        }

        header p {
            font-size: 1.2em;
            opacity: 0.9;
        }

        /* ===========================
           NAVIGATION
           =========================== */
        nav {
            background: #2c3e50;
            padding: 15px 40px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }

        nav a {
            color: white;
            text-decoration: none;
            padding: 8px 15px;
            border-radius: 5px;
            transition: background 0.3s;
            font-size: 0.95em;
        }

        nav a:hover {
            background: #34495e;
        }

        /* ===========================
           MAIN CONTENT
           =========================== */
        main {
            padding: 40px;
        }

        section {
            margin-bottom: 60px;
        }

        section h2 {
            font-size: 2em;
            margin-bottom: 20px;
            color: #2c3e50;
            border-bottom: 3px solid #3498db;
            padding-bottom: 10px;
        }

        section h3 {
            font-size: 1.5em;
            margin-top: 30px;
            margin-bottom: 15px;
            color: #34495e;
        }

        section p {
            margin-bottom: 15px;
            line-height: 1.8;
        }

        /* ===========================
           COMPONENT CARDS
           =========================== */
        .component-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 25px;
            margin-top: 30px;
        }

        .component-card {
            background: white;
            border-left: 5px solid;
            border-radius: 8px;
            padding: 25px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            transition: transform 0.3s, box-shadow 0.3s;
            cursor: pointer;
        }

        .component-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }

        .component-card h4 {
            font-size: 1.3em;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .component-card .badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.75em;
            font-weight: 600;
            color: white;
        }

        .component-card .details {
            display: none;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #eee;
        }

        .component-card.expanded .details {
            display: block;
        }

        .component-card .expand-icon {
            margin-left: auto;
            transition: transform 0.3s;
        }

        .component-card.expanded .expand-icon {
            transform: rotate(180deg);
        }

        /* Color coding by layer */
        .layer-api { border-left-color: #3498db; }
        .layer-orchestration { border-left-color: #9b59b6; }
        .layer-models { border-left-color: #2ecc71; }
        .layer-services { border-left-color: #f39c12; }
        .layer-database { border-left-color: #e74c3c; }
        .layer-query { border-left-color: #e67e22; }
        .layer-monitoring { border-left-color: #95a5a6; }

        .badge-api { background: #3498db; }
        .badge-orchestration { background: #9b59b6; }
        .badge-models { background: #2ecc71; }
        .badge-services { background: #f39c12; }
        .badge-database { background: #e74c3c; }
        .badge-query { background: #e67e22; }
        .badge-monitoring { background: #95a5a6; }

        /* ===========================
           METRICS & STATS
           =========================== */
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }

        .metric-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .metric-card .value {
            font-size: 2.5em;
            font-weight: 700;
            margin-bottom: 10px;
        }

        .metric-card .label {
            font-size: 0.9em;
            opacity: 0.9;
        }

        /* ===========================
           DATA FLOW DIAGRAMS
           =========================== */
        .diagram-container {
            background: #f8f9fa;
            padding: 30px;
            border-radius: 10px;
            margin: 30px 0;
            overflow-x: auto;
        }

        .diagram-container svg {
            max-width: 100%;
            height: auto;
        }

        /* ===========================
           CODE BLOCKS
           =========================== */
        .code-block {
            background: #2c3e50;
            color: #ecf0f1;
            padding: 20px;
            border-radius: 8px;
            overflow-x: auto;
            margin: 15px 0;
            font-family: 'Monaco', 'Courier New', monospace;
            font-size: 0.9em;
            line-height: 1.5;
        }

        .code-block .file-path {
            color: #3498db;
            margin-bottom: 10px;
            display: block;
        }

        /* ===========================
           LISTS
           =========================== */
        ul.feature-list {
            list-style: none;
            padding-left: 0;
        }

        ul.feature-list li {
            padding: 10px 0 10px 30px;
            position: relative;
        }

        ul.feature-list li:before {
            content: "‚úì";
            position: absolute;
            left: 0;
            color: #2ecc71;
            font-weight: bold;
            font-size: 1.2em;
        }

        /* ===========================
           TABLES
           =========================== */
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        table thead {
            background: #2c3e50;
            color: white;
        }

        table th, table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        table tbody tr:hover {
            background: #f8f9fa;
        }

        /* ===========================
           RESPONSIVE
           =========================== */
        @media (max-width: 768px) {
            header h1 {
                font-size: 1.8em;
            }

            nav {
                flex-direction: column;
                align-items: flex-start;
            }

            .component-grid {
                grid-template-columns: 1fr;
            }

            .metrics-grid {
                grid-template-columns: 1fr;
            }
        }

        /* ===========================
           PRINT STYLES
           =========================== */
        @media print {
            body {
                background: white;
                padding: 0;
            }

            .container {
                box-shadow: none;
            }

            nav {
                display: none;
            }

            .component-card .details {
                display: block !important;
            }
        }

        /* ===========================
           UTILITIES
           =========================== */
        .text-center {
            text-align: center;
        }

        .mt-3 {
            margin-top: 30px;
        }

        .mb-3 {
            margin-bottom: 30px;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- HEADER -->
        <header>
            <h1>üß† Apex Memory System</h1>
            <p>Multi-Database Intelligence Platform - Technical Architecture Manual</p>
        </header>

        <!-- NAVIGATION -->
        <nav>
            <a href="#summary">Summary</a>
            <a href="#api">API Layer</a>
            <a href="#orchestration">Orchestration</a>
            <a href="#models">Data Models</a>
            <a href="#services">Services</a>
            <a href="#databases">Databases</a>
            <a href="#query">Query Router</a>
            <a href="#monitoring">Monitoring</a>
            <a href="#flows">Data Flows</a>
        </nav>

        <!-- MAIN CONTENT -->
        <main>
            <!-- ===========================
                 EXECUTIVE SUMMARY
                 =========================== -->
            <section id="summary">
                <h2>üìã Executive Summary</h2>
                <p>
                    The <strong>Apex Memory System</strong> is a production-ready, multi-database intelligence platform
                    that ingests documents and structured data (JSON), extracts entities using LLM-powered analysis,
                    and provides hybrid query routing across 4 specialized databases.
                </p>

                <p>
                    The system uses <strong>Temporal.io</strong> for durable workflow orchestration, ensuring automatic
                    retries, state persistence, and complete observability. All writes are coordinated via an
                    <strong>Enhanced Saga pattern</strong> (121 tests passing) with distributed locking, idempotency,
                    and circuit breakers.
                </p>

                <div class="metrics-grid">
                    <div class="metric-card">
                        <div class="value">10+</div>
                        <div class="label">Documents/Second</div>
                    </div>
                    <div class="metric-card">
                        <div class="value">&lt;1s</div>
                        <div class="label">Query Latency (P90)</div>
                    </div>
                    <div class="metric-card">
                        <div class="value">4</div>
                        <div class="label">Parallel Databases</div>
                    </div>
                    <div class="metric-card">
                        <div class="value">90%</div>
                        <div class="label">Entity Extraction Accuracy</div>
                    </div>
                    <div class="metric-card">
                        <div class="value">27</div>
                        <div class="label">Temporal Metrics</div>
                    </div>
                    <div class="metric-card">
                        <div class="value">121</div>
                        <div class="label">Saga Tests Passing</div>
                    </div>
                </div>

                <h3>üèóÔ∏è Architecture Layers</h3>
                <ul class="feature-list">
                    <li><strong style="color: #3498db;">API Layer</strong> - FastAPI endpoints for document/JSON ingestion</li>
                    <li><strong style="color: #9b59b6;">Temporal Orchestration</strong> - 2 workflows, 9 activities, durable execution</li>
                    <li><strong style="color: #2ecc71;">Data Models</strong> - Pydantic models for documents, JSON, Graphiti entities</li>
                    <li><strong style="color: #f39c12;">Services</strong> - Enhanced Saga, Graphiti, Parsing, Embeddings, Staging</li>
                    <li><strong style="color: #e74c3c;">Database Writers</strong> - PostgreSQL, Neo4j, Qdrant, Redis (parallel writes)</li>
                    <li><strong style="color: #e67e22;">Query Router</strong> - LLM-based intent classification, hybrid routing</li>
                    <li><strong style="color: #95a5a6;">Monitoring</strong> - Grafana, Prometheus, structured logging</li>
                </ul>

                <h3>üéØ Key Capabilities</h3>
                <div class="component-grid">
                    <div class="component-card layer-api">
                        <h4>Document Ingestion</h4>
                        <p>Upload PDF, DOCX, PPTX, HTML, Markdown files via API. Automatic parsing, entity extraction, and database writes.</p>
                    </div>
                    <div class="component-card layer-orchestration">
                        <h4>JSON Ingestion</h4>
                        <p>Ingest structured data from Samsara (GPS), Turvo (shipments), FrontApp (messages) with LLM entity extraction.</p>
                    </div>
                    <div class="component-card layer-query">
                        <h4>Hybrid Query Routing</h4>
                        <p>Intelligent routing to optimal database based on query intent: graph, temporal, semantic, or metadata.</p>
                    </div>
                    <div class="component-card layer-services">
                        <h4>Enhanced Saga Pattern</h4>
                        <p>Atomic writes across 4 databases with automatic rollback, distributed locking, and idempotency (121 tests).</p>
                    </div>
                </div>
            </section>

            <!-- ===========================
                 API LAYER
                 =========================== -->
            <section id="api">
                <h2 style="color: #3498db;">üîµ API Layer - FastAPI Endpoints</h2>
                <p>
                    The API layer provides REST endpoints for document and JSON ingestion. All operations are
                    <strong>non-blocking</strong> - they start Temporal workflows and return immediately with a
                    <code>workflow_id</code> for status tracking.
                </p>

                <div class="component-grid">
                    <div class="component-card layer-api">
                        <h4>
                            POST /api/v1/ingest
                            <span class="expand-icon">‚ñº</span>
                        </h4>
                        <span class="badge badge-api">Document Upload</span>
                        <p>Upload documents (PDF, DOCX, PPTX, HTML, MD, TXT) for ingestion.</p>
                        <div class="details">
                            <strong>Request:</strong>
                            <div class="code-block">
POST /api/v1/ingest
Content-Type: multipart/form-data
file: &lt;binary data&gt;
source: "api" | "frontapp" | "local_upload"
                            </div>
                            <strong>Response:</strong>
                            <div class="code-block">
{
  "success": true,
  "uuid": "550e8400-e29b-41d4-a716-446655440000",
  "workflow_id": "ingest-550e8400...",
  "filename": "report.pdf",
  "source": "api",
  "status": "processing",
  "staging_path": "/tmp/apex-staging/api/550e8400.../report.pdf"
}
                            </div>
                            <strong>Workflow Triggered:</strong> <code>DocumentIngestionWorkflow</code>
                            <br><strong>File Location:</strong> <code>src/apex_memory/api/ingestion.py:148</code>
                        </div>
                    </div>

                    <div class="component-card layer-api">
                        <h4>
                            POST /api/v1/ingest-structured
                            <span class="expand-icon">‚ñº</span>
                        </h4>
                        <span class="badge badge-api">JSON Ingestion</span>
                        <p>Ingest structured JSON data from external APIs (Samsara, Turvo, FrontApp).</p>
                        <div class="details">
                            <strong>Request:</strong>
                            <div class="code-block">
POST /api/v1/ingest-structured
Content-Type: application/json
{
  "data_id": "GPS-2025-001",
  "source": "samsara",
  "source_endpoint": "https://api.samsara.com/v1/fleet/...",
  "data_type": "gps_event"
}
                            </div>
                            <strong>Response:</strong>
                            <div class="code-block">
{
  "success": true,
  "data_id": "GPS-2025-001",
  "workflow_id": "ingest-json-GPS-2025-001",
  "source": "samsara",
  "data_type": "gps_event",
  "status": "processing"
}
                            </div>
                            <strong>Workflow Triggered:</strong> <code>StructuredDataIngestionWorkflow</code>
                        </div>
                    </div>

                    <div class="component-card layer-api">
                        <h4>
                            GET /api/v1/health
                            <span class="expand-icon">‚ñº</span>
                        </h4>
                        <span class="badge badge-api">Health Check</span>
                        <p>Check API and database connection health.</p>
                        <div class="details">
                            <strong>Response:</strong>
                            <div class="code-block">
{
  "status": "healthy",
  "databases": {
    "neo4j": true,
    "postgres": true,
    "qdrant": true,
    "redis": true
  }
}
                            </div>
                            <strong>Checks:</strong> Connection pool status for all 4 databases
                        </div>
                    </div>

                    <div class="component-card layer-api">
                        <h4>
                            GET /api/v1/workflow/{id}/status
                            <span class="expand-icon">‚ñº</span>
                        </h4>
                        <span class="badge badge-api">Status Query</span>
                        <p>Query Temporal workflow status (non-blocking).</p>
                        <div class="details">
                            <strong>Response:</strong>
                            <div class="code-block">
{
  "uuid": "550e8400-e29b-41d4-a716-446655440000",
  "workflow_id": "ingest-550e8400...",
  "status": "parsed",
  "document_id": "DOC-123",
  "source": "api",
  "file_path": "/tmp/apex-staging/api/.../report.pdf"
}
                            </div>
                            <strong>Status Values:</strong> pending, staging, staged, parsing, parsed,
                            extracting_entities, entities_extracted, generating_embeddings,
                            embeddings_generated, writing_databases, completed, failed
                        </div>
                    </div>
                </div>

                <div class="code-block">
                    <span class="file-path">üìÅ src/apex_memory/api/ingestion.py</span>
Lines 148-200: Document ingestion endpoint
Lines 62-74: IngestionResponse model
Lines 94-113: StructuredDataIngestionRequest/Response models
                </div>
            </section>

            <!-- ===========================
                 TEMPORAL ORCHESTRATION
                 =========================== -->
            <section id="orchestration">
                <h2 style="color: #9b59b6;">üü£ Temporal Orchestration - Durable Workflows</h2>
                <p>
                    Temporal.io orchestrates all ingestion workflows with automatic retries, state persistence,
                    and complete observability. Workers execute activities that wrap existing services.
                </p>

                <h3>Workflows</h3>
                <div class="component-grid">
                    <div class="component-card layer-orchestration">
                        <h4>
                            DocumentIngestionWorkflow
                            <span class="expand-icon">‚ñº</span>
                        </h4>
                        <span class="badge badge-orchestration">6 Steps</span>
                        <p>Orchestrates document ingestion from upload to database writes.</p>
                        <div class="details">
                            <strong>Steps:</strong>
                            <ol>
                                <li><strong>Stage</strong> - Pull document and save to local staging (<code>/tmp/apex-staging/</code>)</li>
                                <li><strong>Parse</strong> - Extract content using Docling (30s timeout, 3 retries)</li>
                                <li><strong>Extract</strong> - Graphiti LLM entity extraction (2min timeout, 3 retries)</li>
                                <li><strong>Embed</strong> - Generate OpenAI embeddings (3min timeout, 5 retries)</li>
                                <li><strong>Write</strong> - Enhanced Saga to 4 databases (5min timeout, 3 retries)</li>
                                <li><strong>Cleanup</strong> - Remove staging directory (10s timeout, 2 retries)</li>
                            </ol>
                            <strong>Retry Policy:</strong> Exponential backoff with max attempts per activity
                            <br><strong>Observability:</strong> All steps visible in Temporal UI
                            <br><strong>File Location:</strong> <code>src/apex_memory/temporal/workflows/ingestion.py:45</code>
                        </div>
                    </div>

                    <div class="component-card layer-orchestration">
                        <h4>
                            StructuredDataIngestionWorkflow
                            <span class="expand-icon">‚ñº</span>
                        </h4>
                        <span class="badge badge-orchestration">4 Steps</span>
                        <p>Orchestrates JSON ingestion from external APIs (Samsara, Turvo, FrontApp).</p>
                        <div class="details">
                            <strong>Steps:</strong>
                            <ol>
                                <li><strong>Fetch</strong> - Fetch JSON from API or webhook (2min timeout, 5 retries)</li>
                                <li><strong>Extract</strong> - Graphiti JSON entity extraction (5min timeout, 3 retries)</li>
                                <li><strong>Embed</strong> - Generate embedding for text representation (3min timeout, 5 retries)</li>
                                <li><strong>Write</strong> - Enhanced Saga to 4 databases (5min timeout, 3 retries)</li>
                            </ol>
                            <strong>No Staging:</strong> JSON fits in Temporal payload (<2MB)
                            <br><strong>File Location:</strong> <code>src/apex_memory/temporal/workflows/ingestion.py:336</code>
                        </div>
                    </div>
                </div>

                <h3>Activities</h3>
                <div class="component-grid">
                    <div class="component-card layer-orchestration">
                        <h4>pull_and_stage_document_activity</h4>
                        <p>Pull document from source and save to local staging directory.</p>
                        <div class="code-block">
Sources: FrontApp API, local file system, HTTP/HTTPS URLs
Output: Local file path (/tmp/apex-staging/{source}/{doc_id}/filename)
File: src/apex_memory/temporal/activities/ingestion.py:1522
                        </div>
                    </div>

                    <div class="component-card layer-orchestration">
                        <h4>parse_document_activity</h4>
                        <p>Parse document using Docling (wraps DocumentParser service).</p>
                        <div class="code-block">
Input: File path
Output: ParsedDocument dict (uuid, content, metadata, chunks)
File: src/apex_memory/temporal/activities/ingestion.py:64
                        </div>
                    </div>

                    <div class="component-card layer-orchestration">
                        <h4>extract_entities_activity</h4>
                        <p>Extract entities using Graphiti LLM (90% accuracy).</p>
                        <div class="code-block">
Input: ParsedDocument dict
Output: {entities: [...], graphiti_episode_uuid: "...", edges_created: N}
Accuracy: 90%+ (vs 60% regex baseline)
File: src/apex_memory/temporal/activities/ingestion.py:274
                        </div>
                    </div>

                    <div class="component-card layer-orchestration">
                        <h4>generate_embeddings_activity</h4>
                        <p>Generate OpenAI embeddings (1536 dims) for document and chunks.</p>
                        <div class="code-block">
Input: ParsedDocument dict
Output: {document_embedding: [1536 floats], chunk_embeddings: [[1536 floats]]}
Model: text-embedding-3-small
File: src/apex_memory/temporal/activities/ingestion.py:528
                        </div>
                    </div>

                    <div class="component-card layer-orchestration">
                        <h4>write_to_databases_activity</h4>
                        <p>Write to all 4 databases via Enhanced Saga (atomic, with rollback).</p>
                        <div class="code-block">
Input: ParsedDocument, entities, embeddings
Saga: Distributed locking, idempotency, circuit breakers
Rollback: Automatic on any DB failure (including Graphiti)
File: src/apex_memory/temporal/activities/ingestion.py:811
                        </div>
                    </div>

                    <div class="component-card layer-orchestration">
                        <h4>cleanup_staging_activity</h4>
                        <p>Cleanup staging directory after ingestion (success or failure).</p>
                        <div class="code-block">
Success: Remove directory entirely
Failed: Update metadata to FAILED (TTL cleanup handles removal)
File: src/apex_memory/temporal/activities/ingestion.py:1849
                        </div>
                    </div>

                    <div class="component-card layer-orchestration">
                        <h4>fetch_structured_data_activity</h4>
                        <p>Fetch JSON from external APIs (Samsara, Turvo, FrontApp webhooks).</p>
                        <div class="code-block">
Samsara: Bearer token authentication
Turvo: Bearer token authentication
FrontApp: JSON parsing from webhook payload
File: src/apex_memory/temporal/activities/ingestion.py:1670
                        </div>
                    </div>

                    <div class="component-card layer-orchestration">
                        <h4>extract_entities_from_json_activity</h4>
                        <p>Extract entities from JSON using Graphiti's JSON API.</p>
                        <div class="code-block">
Input: StructuredData dict
Graphiti: Automatic entity + relationship inference
File: src/apex_memory/temporal/activities/ingestion.py:1091
                        </div>
                    </div>

                    <div class="component-card layer-orchestration">
                        <h4>write_structured_data_activity</h4>
                        <p>Write JSON data to databases via Enhanced Saga (parallel writes).</p>
                        <div class="code-block">
Storage: PostgreSQL JSONB + Neo4j + Qdrant + Redis
Saga: Same Enhanced Saga as documents
File: src/apex_memory/temporal/activities/ingestion.py:1306
                        </div>
                    </div>
                </div>

                <div class="code-block">
                    <span class="file-path">üìÅ src/apex_memory/temporal/</span>
workflows/ingestion.py:45-334 - DocumentIngestionWorkflow
workflows/ingestion.py:336-594 - StructuredDataIngestionWorkflow
activities/ingestion.py:1-1967 - All 9 activities
workers/dev_worker.py - Worker implementation
                </div>
            </section>

            <!-- ===========================
                 DATA MODELS
                 =========================== -->
            <section id="models">
                <h2 style="color: #2ecc71;">üü¢ Data Models - Pydantic Schemas</h2>
                <p>
                    All data structures are defined as Pydantic models for validation, serialization, and documentation.
                </p>

                <div class="component-grid">
                    <div class="component-card layer-models">
                        <h4>
                            ParsedDocument
                            <span class="expand-icon">‚ñº</span>
                        </h4>
                        <span class="badge badge-models">Document Model</span>
                        <p>Represents parsed document with metadata, content, and chunks.</p>
                        <div class="details">
                            <strong>Fields:</strong>
                            <ul>
                                <li><code>uuid</code> - Unique identifier</li>
                                <li><code>metadata</code> - DocumentMetadata (title, author, file_type, etc.)</li>
                                <li><code>content</code> - Full text content (validated non-empty)</li>
                                <li><code>chunks</code> - List of text chunks for embeddings</li>
                                <li><code>structure</code> - Document structure (headings, sections)</li>
                                <li><code>entities</code> - Extracted entities (populated later)</li>
                            </ul>
                            <strong>File:</strong> <code>src/apex_memory/models/document.py:69</code>
                        </div>
                    </div>

                    <div class="component-card layer-models">
                        <h4>
                            StructuredData
                            <span class="expand-icon">‚ñº</span>
                        </h4>
                        <span class="badge badge-models">JSON Model</span>
                        <p>Represents structured JSON data (Samsara, Turvo, FrontApp).</p>
                        <div class="details">
                            <strong>Fields:</strong>
                            <ul>
                                <li><code>uuid</code> - Internal UUID (generated by Apex)</li>
                                <li><code>metadata</code> - StructuredDataMetadata (data_id, source, data_type)</li>
                                <li><code>raw_json</code> - Original JSON payload</li>
                                <li><code>text_representation</code> - Text for embeddings</li>
                                <li><code>entities</code> - Graphiti extracted entities</li>
                                <li><code>graphiti_episode_uuid</code> - For rollback</li>
                            </ul>
                            <strong>Data Types:</strong> GPS_EVENT, SHIPMENT, MESSAGE, GENERIC_JSON
                            <br><strong>File:</strong> <code>src/apex_memory/models/structured_data.py:61</code>
                        </div>
                    </div>

                    <div class="component-card layer-models">
                        <h4>
                            Graphiti Entities
                            <span class="expand-icon">‚ñº</span>
                        </h4>
                        <span class="badge badge-models">Entity Models</span>
                        <p>Domain-specific entity types for 10x better extraction accuracy.</p>
                        <div class="details">
                            <strong>Entity Types:</strong>
                            <ul>
                                <li><strong>Customer</strong> - Account status, balance, contact info</li>
                                <li><strong>Invoice</strong> - Invoice number, amount, dates, status</li>
                                <li><strong>Equipment</strong> - Model, hours, operator, location</li>
                                <li><strong>Person</strong> - Role, company, contact info, license</li>
                                <li><strong>Project</strong> - Project ID, dates, status, budget</li>
                            </ul>
                            <strong>Edge Types:</strong> MANAGES, OPERATES, ISSUED_TO, ASSIGNED_TO,
                            LOCATED_AT, WORKS_WITH, PARTICIPATES_IN, REPORTS_TO, OWNS, MAINTAINS,
                            PAYS_FOR, DELIVERS_TO
                            <br><strong>File:</strong> <code>src/apex_memory/models/graphiti_entities.py:62-412</code>
                        </div>
                    </div>

                    <div class="component-card layer-models">
                        <h4>
                            WriteResult
                            <span class="expand-icon">‚ñº</span>
                        </h4>
                        <span class="badge badge-models">Saga Result</span>
                        <p>Result of parallel database write operation (Enhanced Saga).</p>
                        <div class="details">
                            <strong>Fields:</strong>
                            <ul>
                                <li><code>status</code> - SUCCESS, PARTIAL, FAILED, ROLLED_BACK</li>
                                <li><code>uuid</code> - Document UUID</li>
                                <li><code>neo4j_success</code> - Neo4j write status</li>
                                <li><code>postgres_success</code> - PostgreSQL write status</li>
                                <li><code>qdrant_success</code> - Qdrant write status</li>
                                <li><code>redis_success</code> - Redis write status</li>
                                <li><code>errors</code> - Database-specific error messages</li>
                                <li><code>rollback_performed</code> - Whether rollback was executed</li>
                            </ul>
                            <strong>File:</strong> <code>src/apex_memory/models/document.py:137</code>
                        </div>
                    </div>
                </div>

                <div class="code-block">
                    <span class="file-path">üìÅ src/apex_memory/models/</span>
document.py - ParsedDocument, DocumentMetadata, WriteResult, WriteStatus
structured_data.py - StructuredData, StructuredDataMetadata, StructuredDataType
graphiti_entities.py - Customer, Invoice, Equipment, Person, Project, EdgeTypes
                </div>
            </section>

            <!-- ===========================
                 SERVICES
                 =========================== -->
            <section id="services">
                <h2 style="color: #f39c12;">üü° Services - Business Logic Layer</h2>
                <p>
                    Services implement core business logic including the Enhanced Saga pattern, Graphiti integration,
                    document parsing, embeddings, and staging management.
                </p>

                <div class="component-grid">
                    <div class="component-card layer-services">
                        <h4>
                            DatabaseWriteOrchestrator
                            <span class="expand-icon">‚ñº</span>
                        </h4>
                        <span class="badge badge-services">Enhanced Saga</span>
                        <p>Coordinates parallel writes to 4 databases with saga pattern (121 tests passing).</p>
                        <div class="details">
                            <strong>Capabilities:</strong>
                            <ul class="feature-list">
                                <li><strong>Distributed Locking</strong> - Prevents concurrent writes (Redis-based)</li>
                                <li><strong>Idempotency</strong> - Safe retries without duplicates (24hr TTL cache)</li>
                                <li><strong>Circuit Breakers</strong> - Prevents cascade failures (5 failures = open)</li>
                                <li><strong>Exponential Backoff</strong> - Automatic retries with increasing delays</li>
                                <li><strong>Parallel Writes</strong> - All 4 DBs written simultaneously</li>
                                <li><strong>Atomic Saga</strong> - All succeed or all rollback</li>
                                <li><strong>Graphiti Rollback</strong> - Remove orphaned episodes on failure</li>
                            </ul>
                            <strong>Databases:</strong> Neo4j, PostgreSQL, Qdrant, Redis
                            <br><strong>Test Coverage:</strong> 121/121 tests passing
                            <br><strong>File:</strong> <code>src/apex_memory/services/database_writer.py:41</code>
                        </div>
                    </div>

                    <div class="component-card layer-services">
                        <h4>
                            GraphitiService
                            <span class="expand-icon">‚ñº</span>
                        </h4>
                        <span class="badge badge-services">LLM Extraction</span>
                        <p>LLM-powered entity and relationship extraction (90% accuracy).</p>
                        <div class="details">
                            <strong>Methods:</strong>
                            <ul>
                                <li><code>add_document_episode()</code> - Extract from documents</li>
                                <li><code>add_json_episode()</code> - Extract from structured JSON</li>
                                <li><code>remove_episode()</code> - Rollback episode (for Saga)</li>
                            </ul>
                            <strong>Entity Types:</strong> Custom Pydantic models (Customer, Invoice, Equipment, etc.)
                            <br><strong>Accuracy:</strong> 90%+ (vs 60% regex baseline)
                            <br><strong>Powered by:</strong> graphiti-core 0.22.0
                        </div>
                    </div>

                    <div class="component-card layer-services">
                        <h4>
                            DocumentParser
                            <span class="expand-icon">‚ñº</span>
                        </h4>
                        <span class="badge badge-services">Docling Parser</span>
                        <p>Multi-format document parsing with Docling integration.</p>
                        <div class="details">
                            <strong>Supported Formats:</strong>
                            <ul>
                                <li>PDF - Docling with OCR fallback</li>
                                <li>DOCX - python-docx</li>
                                <li>PPTX - python-pptx</li>
                                <li>HTML - BeautifulSoup4</li>
                                <li>Markdown - markdown-it-py</li>
                                <li>TXT - Direct text extraction</li>
                            </ul>
                            <strong>Output:</strong> ParsedDocument with content, chunks, metadata
                        </div>
                    </div>

                    <div class="component-card layer-services">
                        <h4>
                            EmbeddingService
                            <span class="expand-icon">‚ñº</span>
                        </h4>
                        <span class="badge badge-services">OpenAI Embeddings</span>
                        <p>Generate embeddings for semantic search (1536 dimensions).</p>
                        <div class="details">
                            <strong>Model:</strong> text-embedding-3-small
                            <br><strong>Dimensions:</strong> 1536
                            <br><strong>Methods:</strong>
                            <ul>
                                <li><code>generate_embedding(text)</code> - Single embedding</li>
                                <li><code>generate_embeddings(texts)</code> - Batch embeddings</li>
                            </ul>
                            <strong>Retry Logic:</strong> Exponential backoff for rate limits
                        </div>
                    </div>

                    <div class="component-card layer-services">
                        <h4>
                            StagingManager
                            <span class="expand-icon">‚ñº</span>
                        </h4>
                        <span class="badge badge-services">Local Staging</span>
                        <p>Manage local staging infrastructure (/tmp/apex-staging/).</p>
                        <div class="details">
                            <strong>Directory Structure:</strong>
                            <div class="code-block">
/tmp/apex-staging/
‚îú‚îÄ‚îÄ frontapp/
‚îÇ   ‚îî‚îÄ‚îÄ DOC-123/
‚îÇ       ‚îú‚îÄ‚îÄ document.pdf
‚îÇ       ‚îî‚îÄ‚îÄ metadata.json
‚îú‚îÄ‚îÄ api/
‚îî‚îÄ‚îÄ local_upload/
                            </div>
                            <strong>Features:</strong>
                            <ul>
                                <li>TTL-based cleanup (24hr success, 72hr failed)</li>
                                <li>Status tracking (PENDING, SUCCESS, FAILED)</li>
                                <li>Metrics reporting</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <div class="code-block">
                    <span class="file-path">üìÅ src/apex_memory/services/</span>
database_writer.py - DatabaseWriteOrchestrator (Enhanced Saga)
graphiti_service.py - GraphitiService (LLM extraction)
document_parser.py - DocumentParser (Docling)
embedding_service.py - EmbeddingService (OpenAI)
staging_manager.py - StagingManager (local staging)
distributed_lock.py - Redis distributed locking
idempotency.py - Idempotency manager
circuit_breaker.py - Circuit breaker pattern
                </div>
            </section>

            <!-- ===========================
                 DATABASE WRITERS
                 =========================== -->
            <section id="databases">
                <h2 style="color: #e74c3c;">üî¥ Database Writers - 4 Parallel Databases</h2>
                <p>
                    The system writes to 4 specialized databases in parallel for optimal query performance.
                    Each database serves a specific purpose in the intelligence platform.
                </p>

                <table>
                    <thead>
                        <tr>
                            <th>Database</th>
                            <th>Purpose</th>
                            <th>Storage</th>
                            <th>Query Performance</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><strong>PostgreSQL + pgvector</strong></td>
                            <td>Metadata search + Hybrid semantic queries</td>
                            <td>Documents, chunks, embeddings (1536 dims)</td>
                            <td>&lt;100ms for metadata, &lt;500ms for vectors</td>
                        </tr>
                        <tr>
                            <td><strong>Neo4j</strong></td>
                            <td>Graph relationships + Entity connections</td>
                            <td>Entities, relationships, properties</td>
                            <td>&lt;200ms for graph traversal</td>
                        </tr>
                        <tr>
                            <td><strong>Qdrant</strong></td>
                            <td>High-performance vector similarity search</td>
                            <td>Embeddings (1536 dims), HNSW index</td>
                            <td>&lt;50ms for vector similarity</td>
                        </tr>
                        <tr>
                            <td><strong>Redis</strong></td>
                            <td>Cache layer + Distributed locking</td>
                            <td>Query results (70%+ hit rate), locks, idempotency</td>
                            <td>&lt;10ms for cache hits</td>
                        </tr>
                    </tbody>
                </table>

                <div class="component-grid">
                    <div class="component-card layer-database">
                        <h4>
                            PostgresWriter
                            <span class="expand-icon">‚ñº</span>
                        </h4>
                        <span class="badge badge-database">pgvector</span>
                        <p>Write documents, chunks, and embeddings to PostgreSQL.</p>
                        <div class="details">
                            <strong>Tables:</strong>
                            <ul>
                                <li><code>documents</code> - Metadata + full text + embedding</li>
                                <li><code>chunks</code> - Text chunks + chunk embeddings</li>
                                <li><code>structured_data</code> - JSON data (JSONB) + embeddings</li>
                            </ul>
                            <strong>Vector Operations:</strong>
                            <ul>
                                <li>Cosine similarity search</li>
                                <li>Hybrid full-text + vector search</li>
                                <li>Metadata filtering</li>
                            </ul>
                            <strong>Connection Pool:</strong> 2-20 connections
                            <br><strong>File:</strong> <code>src/apex_memory/database/postgres_writer.py:36</code>
                        </div>
                    </div>

                    <div class="component-card layer-database">
                        <h4>
                            Neo4jWriter
                            <span class="expand-icon">‚ñº</span>
                        </h4>
                        <span class="badge badge-database">Graph DB</span>
                        <p>Write entities and relationships to Neo4j knowledge graph.</p>
                        <div class="details">
                            <strong>Node Types:</strong>
                            <ul>
                                <li>Document</li>
                                <li>Entity (Customer, Invoice, Equipment, Person, Project)</li>
                                <li>Chunk</li>
                            </ul>
                            <strong>Relationship Types:</strong>
                            <ul>
                                <li>HAS_ENTITY (Document ‚Üí Entity)</li>
                                <li>HAS_CHUNK (Document ‚Üí Chunk)</li>
                                <li>REFERENCES (Chunk ‚Üí Entity)</li>
                                <li>Custom: MANAGES, OPERATES, ISSUED_TO, etc.</li>
                            </ul>
                            <strong>Graphiti Integration:</strong> Temporal relationships via Graphiti
                        </div>
                    </div>

                    <div class="component-card layer-database">
                        <h4>
                            QdrantWriter
                            <span class="expand-icon">‚ñº</span>
                        </h4>
                        <span class="badge badge-database">Vector DB</span>
                        <p>Write embeddings to Qdrant for high-performance similarity search.</p>
                        <div class="details">
                            <strong>Collections:</strong>
                            <ul>
                                <li><code>documents</code> - Document-level embeddings</li>
                                <li><code>chunks</code> - Chunk embeddings</li>
                                <li><code>structured_data</code> - JSON embeddings</li>
                            </ul>
                            <strong>Index:</strong> HNSW (Hierarchical Navigable Small World)
                            <br><strong>Distance Metric:</strong> Cosine similarity
                            <br><strong>Dimensions:</strong> 1536 (text-embedding-3-small)
                        </div>
                    </div>

                    <div class="component-card layer-database">
                        <h4>
                            RedisWriter
                            <span class="expand-icon">‚ñº</span>
                        </h4>
                        <span class="badge badge-database">Cache + Locks</span>
                        <p>Cache query results, manage distributed locks, and track idempotency.</p>
                        <div class="details">
                            <strong>Use Cases:</strong>
                            <ul>
                                <li><strong>Query Cache</strong> - 70%+ hit rate for repeat queries</li>
                                <li><strong>Distributed Locks</strong> - Prevent concurrent writes</li>
                                <li><strong>Idempotency</strong> - Track processed requests (24hr TTL)</li>
                                <li><strong>Staging Metadata</strong> - Track staging directory status</li>
                            </ul>
                            <strong>TTL:</strong> Configurable per use case
                        </div>
                    </div>
                </div>

                <div class="code-block">
                    <span class="file-path">üìÅ src/apex_memory/database/</span>
postgres_writer.py - PostgreSQL + pgvector writer
neo4j_writer.py - Neo4j graph writer
qdrant_writer.py - Qdrant vector writer
redis_writer.py - Redis cache/lock writer
                </div>
            </section>

            <!-- ===========================
                 QUERY ROUTER
                 =========================== -->
            <section id="query">
                <h2 style="color: #e67e22;">üü† Query Router - Intelligent Query Routing</h2>
                <p>
                    The query router uses a hybrid classification system to route queries to the optimal database
                    based on intent: <strong>graph</strong>, <strong>temporal</strong>, <strong>semantic</strong>,
                    or <strong>metadata</strong>.
                </p>

                <h3>Classification Pipeline</h3>
                <div class="component-grid">
                    <div class="component-card layer-query">
                        <h4>
                            LLMIntentClassifier
                            <span class="expand-icon">‚ñº</span>
                        </h4>
                        <span class="badge badge-query">Claude 3.5 Sonnet</span>
                        <p>High-accuracy intent classification for ambiguous queries (95%+ accuracy).</p>
                        <div class="details">
                            <strong>Intent Types:</strong>
                            <ul>
                                <li><strong>graph</strong> - Relationships, connections, hierarchies ("which vendors supply brake parts")</li>
                                <li><strong>temporal</strong> - Time-based, trends, changes ("track SOP revisions over past year")</li>
                                <li><strong>semantic</strong> - Content search, meaning-based ("find safety procedures")</li>
                                <li><strong>metadata</strong> - System info, catalogs, filters ("list all active drivers")</li>
                            </ul>
                            <strong>Model:</strong> claude-3-5-sonnet-20241022
                            <br><strong>Latency:</strong> ~500ms
                            <br><strong>Accuracy:</strong> 95%+ on ambiguous queries
                            <br><strong>File:</strong> <code>src/apex_memory/query_router/llm_classifier.py:27</code>
                        </div>
                    </div>

                    <div class="component-card layer-query">
                        <h4>
                            SemanticClassifier
                            <span class="expand-icon">‚ñº</span>
                        </h4>
                        <span class="badge badge-query">Embedding-based</span>
                        <p>Fast embedding-based classification (fallback from LLM).</p>
                        <div class="details">
                            <strong>Method:</strong>
                            <ol>
                                <li>Generate query embedding (OpenAI)</li>
                                <li>Compare to intent embeddings (cosine similarity)</li>
                                <li>Return intent with highest similarity (confidence threshold: 0.85)</li>
                            </ol>
                            <strong>Latency:</strong> ~100ms
                            <br><strong>Fallback:</strong> If confidence < 0.85, escalate to LLM
                        </div>
                    </div>
                </div>

                <h3>Database Routing</h3>
                <table>
                    <thead>
                        <tr>
                            <th>Intent</th>
                            <th>Primary DB</th>
                            <th>Secondary DB</th>
                            <th>Example Query</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><strong>graph</strong></td>
                            <td>Neo4j</td>
                            <td>Graphiti</td>
                            <td>"Which vendors supply brake parts for Freightliners?"</td>
                        </tr>
                        <tr>
                            <td><strong>temporal</strong></td>
                            <td>Graphiti</td>
                            <td>Neo4j</td>
                            <td>"Track SOP revisions over the past year"</td>
                        </tr>
                        <tr>
                            <td><strong>semantic</strong></td>
                            <td>Qdrant</td>
                            <td>PostgreSQL</td>
                            <td>"Find procedures related to hazmat handling"</td>
                        </tr>
                        <tr>
                            <td><strong>metadata</strong></td>
                            <td>PostgreSQL</td>
                            <td>-</td>
                            <td>"List all active drivers in California region"</td>
                        </tr>
                    </tbody>
                </table>

                <h3>Query Flow</h3>
                <div class="component-grid">
                    <div class="component-card layer-query">
                        <h4>1. Cache Check</h4>
                        <p>Check Redis for cached results (70%+ hit rate, <10ms latency).</p>
                    </div>
                    <div class="component-card layer-query">
                        <h4>2. Intent Classification</h4>
                        <p>Semantic classifier (fast) ‚Üí LLM classifier (if low confidence).</p>
                    </div>
                    <div class="component-card layer-query">
                        <h4>3. Database Routing</h4>
                        <p>Route to optimal database based on intent.</p>
                    </div>
                    <div class="component-card layer-query">
                        <h4>4. Result Fusion</h4>
                        <p>Aggregate results from primary + secondary databases.</p>
                    </div>
                    <div class="component-card layer-query">
                        <h4>5. Cache Update</h4>
                        <p>Cache result in Redis for future queries.</p>
                    </div>
                </div>

                <div class="code-block">
                    <span class="file-path">üìÅ src/apex_memory/query_router/</span>
llm_classifier.py - Claude 3.5 Sonnet intent classification
semantic_classifier.py - Embedding-based classification
analyzer.py - Query analysis and preprocessing
result_fusion.py - Aggregate results from multiple DBs
cache.py - Redis query caching
postgres_queries.py - PostgreSQL query builders
neo4j_queries.py - Neo4j Cypher query builders
graphiti_queries.py - Graphiti temporal queries
                </div>
            </section>

            <!-- ===========================
                 MONITORING
                 =========================== -->
            <section id="monitoring">
                <h2 style="color: #95a5a6;">‚ö™ Monitoring - Observability & Metrics</h2>
                <p>
                    The system provides complete observability with 27 Temporal metrics across 6 layers,
                    Grafana dashboards, Prometheus alerts, and structured logging.
                </p>

                <h3>Monitoring Layers</h3>
                <div class="component-grid">
                    <div class="component-card layer-monitoring">
                        <h4>1. Workflow Metrics</h4>
                        <ul>
                            <li><code>temporal_workflow_started_total</code></li>
                            <li><code>temporal_workflow_completed_total</code></li>
                            <li><code>temporal_workflow_duration_seconds</code></li>
                        </ul>
                    </div>
                    <div class="component-card layer-monitoring">
                        <h4>2. Activity Metrics</h4>
                        <ul>
                            <li><code>temporal_activity_started_total</code></li>
                            <li><code>temporal_activity_completed_total</code></li>
                            <li><code>temporal_activity_duration_seconds</code></li>
                            <li><code>temporal_activity_attempts</code></li>
                        </ul>
                    </div>
                    <div class="component-card layer-monitoring">
                        <h4>3. Data Quality Metrics</h4>
                        <ul>
                            <li><code>temporal_chunks_per_document</code></li>
                            <li><code>temporal_entities_per_document</code></li>
                            <li><code>temporal_embeddings_per_document</code></li>
                        </ul>
                    </div>
                    <div class="component-card layer-monitoring">
                        <h4>4. Infrastructure Metrics</h4>
                        <ul>
                            <li><code>temporal_database_writes_total</code></li>
                            <li><code>temporal_saga_rollbacks_total</code></li>
                        </ul>
                    </div>
                    <div class="component-card layer-monitoring">
                        <h4>5. Business Metrics</h4>
                        <ul>
                            <li><code>temporal_documents_ingested_total</code></li>
                            <li><code>temporal_json_ingested_total</code></li>
                            <li><code>temporal_bytes_processed_total</code></li>
                        </ul>
                    </div>
                    <div class="component-card layer-monitoring">
                        <h4>6. Logs & Traces</h4>
                        <ul>
                            <li>Structured JSON logging</li>
                            <li>Temporal UI traces</li>
                            <li>Activity execution history</li>
                        </ul>
                    </div>
                </div>

                <h3>Dashboards & Alerts</h3>
                <div class="component-grid">
                    <div class="component-card layer-monitoring">
                        <h4>
                            Grafana Dashboard
                            <span class="expand-icon">‚ñº</span>
                        </h4>
                        <span class="badge badge-monitoring">33 Panels</span>
                        <p>Complete Temporal ingestion observability.</p>
                        <div class="details">
                            <strong>Dashboard URL:</strong> <code>http://localhost:3001/d/temporal-ingestion</code>
                            <br><strong>Panels:</strong>
                            <ul>
                                <li>Workflow success rate (last 24h)</li>
                                <li>Activity duration percentiles (P50, P90, P99)</li>
                                <li>Database write success rates</li>
                                <li>Saga rollback frequency</li>
                                <li>Entity extraction accuracy</li>
                                <li>Embedding generation latency</li>
                                <li>Staging directory usage</li>
                                <li>Worker health status</li>
                            </ul>
                            <strong>File:</strong> <code>apex-memory-system/monitoring/dashboards/temporal-ingestion.json</code>
                        </div>
                    </div>

                    <div class="component-card layer-monitoring">
                        <h4>
                            Prometheus Alerts
                            <span class="expand-icon">‚ñº</span>
                        </h4>
                        <span class="badge badge-monitoring">12 Alerts</span>
                        <p>Critical alerts for production failures.</p>
                        <div class="details">
                            <strong>Critical Alerts:</strong>
                            <ul>
                                <li><strong>HighWorkflowFailureRate</strong> - >5% failures in 5min</li>
                                <li><strong>HighActivityFailureRate</strong> - >10% failures in 5min</li>
                                <li><strong>FrequentSagaRollbacks</strong> - >3 rollbacks/min</li>
                                <li><strong>ZeroChunksGenerated</strong> - Silent parsing failure</li>
                                <li><strong>ZeroEntitiesExtracted</strong> - Silent extraction failure</li>
                                <li><strong>DatabaseWriteFailures</strong> - Any DB unavailable >5min</li>
                                <li><strong>WorkerDown</strong> - No worker heartbeat >2min</li>
                            </ul>
                            <strong>File:</strong> <code>apex-memory-system/monitoring/alerts/rules.yml</code>
                        </div>
                    </div>

                    <div class="component-card layer-monitoring">
                        <h4>
                            Debugging Scripts
                            <span class="expand-icon">‚ñº</span>
                        </h4>
                        <span class="badge badge-monitoring">4 Scripts</span>
                        <p>CLI tools for debugging workflows and activities.</p>
                        <div class="details">
                            <strong>Scripts:</strong>
                            <ul>
                                <li><code>check-workflow-status.py</code> - Query workflow status</li>
                                <li><code>list-failed-workflows.py</code> - List recent failures</li>
                                <li><code>compare-metrics.py</code> - Compare Temporal vs Prometheus metrics</li>
                                <li><code>worker-health-check.sh</code> - Check worker health</li>
                            </ul>
                            <strong>Location:</strong> <code>apex-memory-system/scripts/temporal/</code>
                        </div>
                    </div>
                </div>

                <div class="code-block">
                    <span class="file-path">üìÅ Monitoring Stack</span>
src/apex_memory/monitoring/metrics.py - 27 Temporal metrics
monitoring/dashboards/temporal-ingestion.json - 33-panel Grafana dashboard
monitoring/alerts/rules.yml - 12 Prometheus alerts
scripts/temporal/check-workflow-status.py - Workflow debugging
scripts/temporal/list-failed-workflows.py - Failure analysis
scripts/temporal/compare-metrics.py - Metric validation
scripts/temporal/worker-health-check.sh - Worker monitoring
                </div>
            </section>

            <!-- ===========================
                 DATA FLOWS
                 =========================== -->
            <section id="flows">
                <h2>üîÑ Data Flows - System Integration</h2>
                <p>
                    This section visualizes how data flows through the system from ingestion to query.
                </p>

                <h3>1. Document Ingestion Flow</h3>
                <div class="diagram-container">
                    <svg viewBox="0 0 1200 600" xmlns="http://www.w3.org/2000/svg">
                        <!-- User Upload -->
                        <rect x="50" y="50" width="150" height="60" fill="#3498db" rx="10"/>
                        <text x="125" y="85" text-anchor="middle" fill="white" font-size="16" font-weight="bold">User Upload</text>

                        <!-- API -->
                        <rect x="250" y="50" width="150" height="60" fill="#3498db" rx="10"/>
                        <text x="325" y="85" text-anchor="middle" fill="white" font-size="16" font-weight="bold">API Endpoint</text>

                        <!-- Staging -->
                        <rect x="450" y="50" width="150" height="60" fill="#f39c12" rx="10"/>
                        <text x="525" y="85" text-anchor="middle" fill="white" font-size="16" font-weight="bold">Local Staging</text>

                        <!-- Temporal Workflow -->
                        <rect x="650" y="50" width="200" height="60" fill="#9b59b6" rx="10"/>
                        <text x="750" y="85" text-anchor="middle" fill="white" font-size="16" font-weight="bold">Temporal Workflow</text>

                        <!-- Workflow Steps -->
                        <rect x="650" y="150" width="200" height="50" fill="#9b59b6" rx="5"/>
                        <text x="750" y="180" text-anchor="middle" fill="white" font-size="14">1. Parse (Docling)</text>

                        <rect x="650" y="220" width="200" height="50" fill="#9b59b6" rx="5"/>
                        <text x="750" y="250" text-anchor="middle" fill="white" font-size="14">2. Extract (Graphiti)</text>

                        <rect x="650" y="290" width="200" height="50" fill="#9b59b6" rx="5"/>
                        <text x="750" y="320" text-anchor="middle" fill="white" font-size="14">3. Embed (OpenAI)</text>

                        <rect x="650" y="360" width="200" height="50" fill="#9b59b6" rx="5"/>
                        <text x="750" y="390" text-anchor="middle" fill="white" font-size="14">4. Write (Enhanced Saga)</text>

                        <rect x="650" y="430" width="200" height="50" fill="#9b59b6" rx="5"/>
                        <text x="750" y="460" text-anchor="middle" fill="white" font-size="14">5. Cleanup Staging</text>

                        <!-- Databases -->
                        <rect x="900" y="200" width="120" height="50" fill="#e74c3c" rx="5"/>
                        <text x="960" y="230" text-anchor="middle" fill="white" font-size="14">PostgreSQL</text>

                        <rect x="900" y="270" width="120" height="50" fill="#e74c3c" rx="5"/>
                        <text x="960" y="300" text-anchor="middle" fill="white" font-size="14">Neo4j</text>

                        <rect x="900" y="340" width="120" height="50" fill="#e74c3c" rx="5"/>
                        <text x="960" y="370" text-anchor="middle" fill="white" font-size="14">Qdrant</text>

                        <rect x="900" y="410" width="120" height="50" fill="#e74c3c" rx="5"/>
                        <text x="960" y="440" text-anchor="middle" fill="white" font-size="14">Redis</text>

                        <!-- Arrows -->
                        <defs>
                            <marker id="arrowhead" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
                                <polygon points="0 0, 10 3, 0 6" fill="#2c3e50"/>
                            </marker>
                        </defs>

                        <line x1="200" y1="80" x2="250" y2="80" stroke="#2c3e50" stroke-width="3" marker-end="url(#arrowhead)"/>
                        <line x1="400" y1="80" x2="450" y2="80" stroke="#2c3e50" stroke-width="3" marker-end="url(#arrowhead)"/>
                        <line x1="600" y1="80" x2="650" y2="80" stroke="#2c3e50" stroke-width="3" marker-end="url(#arrowhead)"/>
                        <line x1="750" y1="110" x2="750" y2="150" stroke="#2c3e50" stroke-width="3" marker-end="url(#arrowhead)"/>
                        <line x1="750" y1="200" x2="750" y2="220" stroke="#2c3e50" stroke-width="3" marker-end="url(#arrowhead)"/>
                        <line x1="750" y1="270" x2="750" y2="290" stroke="#2c3e50" stroke-width="3" marker-end="url(#arrowhead)"/>
                        <line x1="750" y1="340" x2="750" y2="360" stroke="#2c3e50" stroke-width="3" marker-end="url(#arrowhead)"/>
                        <line x1="750" y1="410" x2="750" y2="430" stroke="#2c3e50" stroke-width="3" marker-end="url(#arrowhead)"/>

                        <line x1="850" y1="385" x2="900" y2="225" stroke="#2c3e50" stroke-width="2" marker-end="url(#arrowhead)"/>
                        <line x1="850" y1="385" x2="900" y2="295" stroke="#2c3e50" stroke-width="2" marker-end="url(#arrowhead)"/>
                        <line x1="850" y1="385" x2="900" y2="365" stroke="#2c3e50" stroke-width="2" marker-end="url(#arrowhead)"/>
                        <line x1="850" y1="385" x2="900" y2="435" stroke="#2c3e50" stroke-width="2" marker-end="url(#arrowhead)"/>

                        <!-- Labels -->
                        <text x="600" y="540" font-size="14" fill="#2c3e50" font-weight="bold">6-Step Workflow with Automatic Retries & Observability</text>
                    </svg>
                </div>

                <h3>2. Query Processing Flow</h3>
                <div class="diagram-container">
                    <svg viewBox="0 0 1200 400" xmlns="http://www.w3.org/2000/svg">
                        <!-- User Query -->
                        <rect x="50" y="50" width="150" height="60" fill="#e67e22" rx="10"/>
                        <text x="125" y="85" text-anchor="middle" fill="white" font-size="16" font-weight="bold">User Query</text>

                        <!-- Cache Check -->
                        <rect x="250" y="50" width="150" height="60" fill="#e74c3c" rx="10"/>
                        <text x="325" y="80" text-anchor="middle" fill="white" font-size="14" font-weight="bold">Cache Check</text>
                        <text x="325" y="95" text-anchor="middle" fill="white" font-size="12">(Redis)</text>

                        <!-- LLM Classifier -->
                        <rect x="450" y="50" width="180" height="60" fill="#e67e22" rx="10"/>
                        <text x="540" y="80" text-anchor="middle" fill="white" font-size="14" font-weight="bold">LLM Classifier</text>
                        <text x="540" y="95" text-anchor="middle" fill="white" font-size="12">(Claude 3.5)</text>

                        <!-- Intent Types -->
                        <rect x="680" y="20" width="120" height="40" fill="#2ecc71" rx="5"/>
                        <text x="740" y="45" text-anchor="middle" fill="white" font-size="12">graph</text>

                        <rect x="680" y="70" width="120" height="40" fill="#2ecc71" rx="5"/>
                        <text x="740" y="95" text-anchor="middle" fill="white" font-size="12">temporal</text>

                        <rect x="680" y="120" width="120" height="40" fill="#2ecc71" rx="5"/>
                        <text x="740" y="145" text-anchor="middle" fill="white" font-size="12">semantic</text>

                        <rect x="680" y="170" width="120" height="40" fill="#2ecc71" rx="5"/>
                        <text x="740" y="195" text-anchor="middle" fill="white" font-size="12">metadata</text>

                        <!-- Database Routing -->
                        <rect x="850" y="20" width="120" height="40" fill="#e74c3c" rx="5"/>
                        <text x="910" y="45" text-anchor="middle" fill="white" font-size="12">Neo4j</text>

                        <rect x="850" y="70" width="120" height="40" fill="#e74c3c" rx="5"/>
                        <text x="910" y="95" text-anchor="middle" fill="white" font-size="12">Graphiti</text>

                        <rect x="850" y="120" width="120" height="40" fill="#e74c3c" rx="5"/>
                        <text x="910" y="145" text-anchor="middle" fill="white" font-size="12">Qdrant</text>

                        <rect x="850" y="170" width="120" height="40" fill="#e74c3c" rx="5"/>
                        <text x="910" y="195" text-anchor="middle" fill="white" font-size="12">PostgreSQL</text>

                        <!-- Result Fusion -->
                        <rect x="1000" y="85" width="150" height="60" fill="#e67e22" rx="10"/>
                        <text x="1075" y="115" text-anchor="middle" fill="white" font-size="14" font-weight="bold">Result Fusion</text>

                        <!-- Arrows -->
                        <line x1="200" y1="80" x2="250" y2="80" stroke="#2c3e50" stroke-width="3" marker-end="url(#arrowhead)"/>
                        <line x1="400" y1="80" x2="450" y2="80" stroke="#2c3e50" stroke-width="3" marker-end="url(#arrowhead)"/>
                        <line x1="630" y1="70" x2="680" y2="40" stroke="#2c3e50" stroke-width="2" marker-end="url(#arrowhead)"/>
                        <line x1="630" y1="80" x2="680" y2="90" stroke="#2c3e50" stroke-width="2" marker-end="url(#arrowhead)"/>
                        <line x1="630" y1="90" x2="680" y2="140" stroke="#2c3e50" stroke-width="2" marker-end="url(#arrowhead)"/>
                        <line x1="630" y1="100" x2="680" y2="190" stroke="#2c3e50" stroke-width="2" marker-end="url(#arrowhead)"/>

                        <line x1="800" y1="40" x2="850" y2="40" stroke="#2c3e50" stroke-width="2" marker-end="url(#arrowhead)"/>
                        <line x1="800" y1="90" x2="850" y2="90" stroke="#2c3e50" stroke-width="2" marker-end="url(#arrowhead)"/>
                        <line x1="800" y1="140" x2="850" y2="140" stroke="#2c3e50" stroke-width="2" marker-end="url(#arrowhead)"/>
                        <line x1="800" y1="190" x2="850" y2="190" stroke="#2c3e50" stroke-width="2" marker-end="url(#arrowhead)"/>

                        <line x1="970" y1="40" x2="1000" y2="105" stroke="#2c3e50" stroke-width="2" marker-end="url(#arrowhead)"/>
                        <line x1="970" y1="90" x2="1000" y2="110" stroke="#2c3e50" stroke-width="2" marker-end="url(#arrowhead)"/>
                        <line x1="970" y1="140" x2="1000" y2="120" stroke="#2c3e50" stroke-width="2" marker-end="url(#arrowhead)"/>
                        <line x1="970" y1="190" x2="1000" y2="125" stroke="#2c3e50" stroke-width="2" marker-end="url(#arrowhead)"/>

                        <!-- Cache Hit Line -->
                        <path d="M 325 110 Q 325 250 1075 250 Q 1075 170 1075 145" stroke="#2ecc71" stroke-width="2" stroke-dasharray="5,5" fill="none" marker-end="url(#arrowhead)"/>
                        <text x="600" y="270" text-anchor="middle" fill="#2ecc71" font-size="12" font-weight="bold">Cache Hit (70%+ queries)</text>

                        <!-- Labels -->
                        <text x="600" y="330" font-size="14" fill="#2c3e50" font-weight="bold">Hybrid Classification ‚Üí Optimal Database Routing ‚Üí Result Aggregation</text>
                    </svg>
                </div>

                <h3>Key Integration Points</h3>
                <table>
                    <thead>
                        <tr>
                            <th>Component A</th>
                            <th>Component B</th>
                            <th>Integration</th>
                            <th>Protocol</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>API</td>
                            <td>Temporal</td>
                            <td>Workflow triggering</td>
                            <td>gRPC (Temporal client)</td>
                        </tr>
                        <tr>
                            <td>Temporal Activities</td>
                            <td>Services</td>
                            <td>Service delegation</td>
                            <td>Direct Python calls</td>
                        </tr>
                        <tr>
                            <td>Enhanced Saga</td>
                            <td>4 Databases</td>
                            <td>Parallel writes</td>
                            <td>ThreadPoolExecutor</td>
                        </tr>
                        <tr>
                            <td>Graphiti</td>
                            <td>Neo4j</td>
                            <td>Entity storage</td>
                            <td>Bolt (Neo4j driver)</td>
                        </tr>
                        <tr>
                            <td>Query Router</td>
                            <td>Databases</td>
                            <td>Intent-based routing</td>
                            <td>Database-specific protocols</td>
                        </tr>
                        <tr>
                            <td>Redis</td>
                            <td>All Components</td>
                            <td>Cache + Locks</td>
                            <td>Redis protocol</td>
                        </tr>
                        <tr>
                            <td>Prometheus</td>
                            <td>All Components</td>
                            <td>Metrics scraping</td>
                            <td>HTTP /metrics endpoint</td>
                        </tr>
                    </tbody>
                </table>
            </section>

            <!-- ===========================
                 TESTING GUIDE
                 =========================== -->
            <section>
                <h2>üß™ Testing the Orchestrator</h2>
                <p>
                    To validate the system works as designed, focus testing on these key integration points:
                </p>

                <h3>Priority 1: Workflow Orchestration</h3>
                <div class="component-grid">
                    <div class="component-card layer-orchestration">
                        <h4>Test: Document Ingestion E2E</h4>
                        <div class="code-block">
# Test full DocumentIngestionWorkflow
pytest tests/integration/test_temporal_ingestion_workflow.py -v -m integration

# Validates:
# - All 6 steps execute in order
# - Retries work correctly
# - State persists across failures
# - Observability metrics recorded
                        </div>
                    </div>

                    <div class="component-card layer-orchestration">
                        <h4>Test: JSON Ingestion E2E</h4>
                        <div class="code-block">
# Test StructuredDataIngestionWorkflow
pytest tests/integration/test_json_integration_e2e.py -v -m integration

# Validates:
# - JSON fetch from APIs
# - Graphiti entity extraction
# - Database writes via Saga
                        </div>
                    </div>
                </div>

                <h3>Priority 2: Enhanced Saga Pattern</h3>
                <div class="component-card layer-services">
                    <h4>Test: 121 Enhanced Saga Tests</h4>
                    <div class="code-block">
# Run all Enhanced Saga tests (baseline validation)
pytest tests/ --ignore=tests/load/ --ignore=tests/integration/ -v

# Key test suites:
# - Distributed locking (prevents concurrent writes)
# - Idempotency (safe retries)
# - Circuit breakers (failure isolation)
# - Rollback (atomic all-or-nothing writes)
# - Graphiti rollback (orphaned episode cleanup)
                    </div>
                </div>

                <h3>Priority 3: Query Router</h3>
                <div class="component-card layer-query">
                    <h4>Test: Intent Classification</h4>
                    <div class="code-block">
# Test LLM classifier accuracy
pytest tests/unit/test_llm_classifier.py -v

# Test semantic classifier
pytest tests/unit/test_semantic_classifier.py -v

# Test database routing logic
pytest tests/unit/test_query_router.py -v
                    </div>
                </div>

                <h3>Priority 4: Load Testing</h3>
                <div class="component-card layer-monitoring">
                    <h4>Test: Concurrent Workflows</h4>
                    <div class="code-block">
# Test concurrent ingestion (load test)
pytest tests/load/test_concurrent_workflows.py -v -m load

# Validates:
# - 10+ documents/second throughput
# - No resource exhaustion
# - Metrics accuracy under load
                    </div>
                </div>

                <h3>Debugging Tools</h3>
                <div class="code-block">
# Check workflow status
python scripts/temporal/check-workflow-status.py --workflow-id ingest-DOC-123

# List recent failures
python scripts/temporal/list-failed-workflows.py --last 24h

# Compare metrics (Temporal vs Prometheus)
python scripts/temporal/compare-metrics.py

# Worker health check
bash scripts/temporal/worker-health-check.sh
                </div>
            </section>

        </main>
    </div>

    <script>
        // ===========================
        // INTERACTIVITY
        // ===========================

        // Expand/collapse component cards
        document.querySelectorAll('.component-card').forEach(card => {
            card.addEventListener('click', function() {
                this.classList.toggle('expanded');
            });
        });

        // Smooth scroll for navigation
        document.querySelectorAll('nav a').forEach(anchor => {
            anchor.addEventListener('click', function(e) {
                e.preventDefault();
                const target = document.querySelector(this.getAttribute('href'));
                target.scrollIntoView({ behavior: 'smooth', block: 'start' });
            });
        });

        // Print button
        console.log('Apex Memory System Manual loaded');
        console.log('Click any component card to expand details');
        console.log('Use navigation to jump between sections');
    </script>
</body>
</html>